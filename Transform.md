

# 坐标变换

    这里我们来大概谈一下空间坐标变换。也就是应用一个什么矩阵，可以将一个空间下的3D坐标变换到另一个
空间坐标系下，并表示同一个位置。


## MPV 变换中的 Model 变换

    Model 变换也就是模型变换，是将一个物体模型从其局部坐标系变换到世界坐标系下的变换。具体操作就是为它所有的
顶点坐标应用 Model 矩阵。

### Model 矩阵是什么？

    说到坐标变换，我们能立刻想到的有 旋转、缩放、平移。恰好这几种变换都可以使用变换矩阵来表示。前面的 旋转、
平移变换由于是齐次变换，使用3*3矩阵即可，而平移变换涉及菲齐次变换，需要多一维度的4*4矩阵。


### 我们应该从什么角度理解 Model 矩阵？

    抛开非齐次变换，先看旋转与缩放变换。例举一个坐标点，从世界坐标系变换到另一个坐标系下。
    1、对于原本的坐标系，各个坐标轴的方向向量一定是(1,0,0) (0,1,0) (0,0,1)
    2、将其进行坐标变换，也就是将以上的轴合并成一个三维矩阵，乘以 Model 矩阵
    3、可知结果一定还是 Model 矩阵本身，因为相乘的原坐标矩阵是一个单位矩阵
    4、那么当前 Model 的三个维度对应的三个向量（因为是齐次变换所以它们一定是正交的三个向量）便可以代表新的
空间坐标轴的方向（在原坐标空间下的表示）。

    那么我们可以反过来想，如果将一个坐标从世界坐标系变换到另一个坐标系下，并且我们也知道那个空间坐标系下各个
坐标轴的方向向量（在原坐标系下的表示），那么是不是就可以用该坐标系下的三个坐标轴方向向量的拼合来表示 Model 变换
矩阵么？答案是可以的。
    所以根据以上，我们可以看出 Model 矩阵 = 目标坐标系下的坐标轴方向向量拼合。

    并且，如果是对向量进行变换，我们更是不需要考虑非齐次变换，因为平移操作前后的向量是不变的。所以对于向量的坐标系变换，更是可以直接应用以上推出的结果。


## TBN 矩阵

    TBN 矩阵是从世界空间坐标向切线空间坐标的变换矩阵。

### 切线空间是什么？

    切线空间是相对于一个模型来说的，对于模型的每一个多边形面元（primitive），其切线空间的三个坐标轴分别用T\B\N来表示。其中N表示当前面元的法向量，T和B都是面元平面内的向量，二者相互垂直，分别为切线向量和副切线向量。TBN三者均以世界坐标系下的坐标进行表示。可知，在模型中的每一个三角形面元都有一个它自己的切线空间（局部空间坐标系）

### 如何从世界坐标变换到切线空间坐标？

    直接阅读网上的一些资料可能会让人有一些困惑，对于我自己来讲，最大的困惑就在于为什么一个向量/坐标乘以了TBN矩阵后就可以变换到切线空间。

    不过，在有了以上对 Model 矩阵以及模型坐标变换的种种解析后，事情变得明朗起来。因为 TBN 矩阵可以直接和 Model 矩阵进行类比。如下：

    1-1 Model 矩阵是从模型局部空间变换到世界坐标 
    1-2 TBN 矩阵是从切线局部空间变换到世界坐标

    2-1 Model 矩阵可以表示为：局部模型坐标系下各个坐标轴在世界坐标系下的表示
    2-2 TBN 矩阵就是局部模型坐标系下各个坐标轴在世界坐标系下表示的拼合（T/B/N就是这三个轴的方向向量）

    3-1 Model 矩阵包括平移变换这种非齐次变换，仅只有旋转、缩放变换时以上说法奏效
    3-2 TBN 矩阵主要是针对法向量的，首先它是向量，可以完美应用以上的推导，因为它不需要平移，一定是齐次变换，齐次法向量一般是单位向量，变换甚至不需要缩放变换，非常契合。

    所以，计算得出 T/B/N 三个向量后即可自由地在世界坐标与切线空间进行变换了。

## 总结

  1、首先明确以上其实涉及了三个坐标空间：世界坐标空间（全局）、模型坐标空间（局部）、切线坐标空间（局部）
  2、切线坐标空间的三个轴向量T、B、N是使用模型空间坐标表示的，模型空间相对于切线空间是一个“全局的”。
  3、对一个多边形面元(primitive)顶点应用 TBN 矩阵，将其从切线空间带入模型空间。
  4、对一个多边形面元(primitive)顶点应用 Model 矩阵，将其从模型空间带入世界坐标空间。
  5、所以从切线坐标空间到世界坐标空间的变换需要两步，先应用 TBN 矩阵，再应用 Model 矩阵
  6、相反从世界坐标到切线坐标，需要先应用 Model 矩阵的逆变换，再应用 TBN 矩阵的逆变换

### 重点应用

    对场景中的光源、摄像机等应用TBN和Model矩阵？其本质含义是什么？首先要明确我们应用TBN矩阵的一个主要原因是对法线贴图的应用。法线贴图始终仅对朝向z轴负方向的的面元适用，而一个三角形贴到模型上，实际上已经应用了一次TBN变换，所以其法线方向必然不一定朝向z。为了可以正确的应用法线贴图，我们就只需要为光源、相机这些位置坐标也应用一次TBN矩阵，即可将其方向调整正确。为了方便理解，其实说白了就是分以下几个步骤：

    1、初始化状态是所有构成模型的多边形面元都朝向z轴负方向，那么此时无论光源在相对多边形面元的哪个位置，计算都将得到正确的结果。注意这里我们只考虑方向，不考虑距离。
    2、将所有的的多边形面元贴到它在模型上的正确位置，也就相当于为每个面元应用了TBN矩阵再加上一个非齐次的平移变换。
    3、由于我们只关心法向量方向以及光源相对于平面的方向，所以不妨只应用TBN矩阵，不应用平移。为了保持光源与多边形面元的相对位置关系不变（也就是光源相对于多边形面元的方向），我们也应该为光源应用TBN矩阵。这样就总能保证光源相对位置、多边形法向量二者之间的夹角永远是正确的。
    4、以上“光源”可以替换为“摄像机/观测点”，同样适用。
    
